# ChordPro Ðµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð·Ð° Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²ÑÐ½Ðµ Ð½Ð° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ðµ Ð½Ð° Ð¿ÐµÑÐ½Ð¸, Ð°Ð½Ð¾Ñ‚Ð¸Ñ€Ð°Ð½Ð¸ Ñ Ð°ÐºÐ¾Ñ€Ð´Ð¸. ÐŸÑ€Ð¸Ð¼ÐµÑ€ÐµÐ½ Ð¾Ñ‚ÐºÑŠÑ:
# For [Fmaj7]here am I [Em]sitting in a tin can
# [Fmaj7]Far above the [Em]world
# [Bb]Planet Earth is [Am]blue and there's [G]nothing I can [F]do
# Ð’ÑÑÐºÐ° Ð¿Ð¾Ñ€ÐµÐ´Ð¸Ñ†Ð° Ð¾Ñ‚ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸, Ð¾Ð³Ñ€Ð°Ð´ÐµÐ½Ð° Ð² ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð½Ð¸ ÑÐºÐ¾Ð±Ð¸, Ñ‰Ðµ Ð½Ð°Ñ€Ð¸Ñ‡Ð°Ð¼Ðµ Ð°ÐºÐ¾Ñ€Ð´. ÐŸÑŠÑ€Ð²Ð¸Ñ‚Ðµ ÐµÐ´Ð¸Ð½ Ð¸Ð»Ð¸ Ð´Ð²Ð°
# ÑÐ¸Ð¼Ð²Ð¾Ð»Ð° Ð½Ð° Ð°ÐºÐ¾Ñ€Ð´Ð° Ð½Ð°Ñ€Ð¸Ñ‡Ð°Ð¼Ðµ Ð¾ÑÐ½Ð¾Ð²ÐµÐ½ Ñ‚Ð¾Ð½.
# ÐÐ°Ð¿Ð¸ÑˆÐµÑ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ transpose.sh, ÐºÐ¾Ð¹Ñ‚Ð¾ Ð¿Ñ€Ð¸ÐµÐ¼Ð° ÐµÐ´Ð¸Ð½ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚ (Ð½ÐµÐ¾Ñ‚Ñ€Ð¸Ñ†Ð°Ñ‚ÐµÐ»Ð½Ð¾ Ñ‡Ð¸ÑÐ»Ð¾ ð‘). Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚
# Ñ‚Ñ€ÑÐ±Ð²Ð° Ð´Ð° Ñ‡ÐµÑ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð²ÑŠÐ² Ñ„Ð¾Ñ€Ð¼Ã Ñ‚Ð° ChordPro Ð¾Ñ‚ stdin Ð¸ Ð´Ð° Ð¸Ð·Ð¿Ð¸ÑÐ²Ð° Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡ÐµÐ½ Ñ‚ÐµÐºÑÑ‚ Ð½Ð° stdout, Ð·Ð°Ð¼ÐµÐ½ÑÐ¹ÐºÐ¸ ÐµÐ´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð¾ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¸Ñ‚Ðµ Ñ‚Ð¾Ð½Ð¾Ð²Ðµ Ð¿Ð¾ ÑÐ»ÐµÐ´Ð½Ð°Ñ‚Ð° ÑÑ…ÐµÐ¼Ð°:
# A Bb B C Db D Eb E F Gb G Ab
# Ð§Ð¸ÑÐ»Ð¾Ñ‚Ð¾ ð‘ Ð·Ð°Ð´Ð°Ð²Ð° Ð±Ñ€Ð¾Ð¹ Ð¿Ñ€ÐµÑ…Ð¾Ð´Ð¸ Ð¿Ð¾ Ñ€ÐµÐ±Ñ€Ð°Ñ‚Ð° Ð·Ð° Ð·Ð°Ð¼ÑÐ½Ð°. ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¿Ñ€Ð¸ Ð¸Ð·Ð¿ÑŠÐ»Ð½ÐµÐ½Ð¸Ðµ Ð½Ð° ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ñ ð‘ = 3
# Ð²ÑŠÑ€Ñ…Ñƒ Ð³Ð¾Ñ€Ð½Ð¸Ñ Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ñ€ÐµÐ·ÑƒÐ»Ñ‚Ð°Ñ‚ÑŠÑ‚ Ð±Ð¸ Ð±Ð¸Ð»:
# For [Abmaj7]here am I [Gm]sitting in a tin can
# [Abmaj7]Far above the [Gm]world
# [Db]Planet Earth is [Cm]blue and there's [Bb]nothing I can [Ab]do


#!/bin/bash

if [[ $# -ne 1 ]]; then
    echo "Expected one arg: number"
    exit 1
fi

if ! echo "${1}" | grep "^[1-9][0-9]*$"; then
    echo "Expected positive number"
    exit 2
fi

validAccords="A Bb B C Db D Eb E F Gb G Ab"
accordsCount=12


fromToneToIndex() {
    if [[ "${1}" == "A" ]]; then
        echo "0"
    elif [[ "${1}" == "Bb" ]]; then
        echo "1"
    elif [[ "${1}" == "B" ]]; then
        echo "2"
    elif [[ "${1}" == "C" ]]; then
        echo "3"
    elif [[ "${1}" == "Db" ]]; then
        echo "4"
    elif [[ "${1}" == "D" ]]; then
        echo "5"
    elif [[ "${1}" == "Eb" ]]; then
        echo "6"
    elif [[ "${1}" == "E" ]]; then
        echo "7"
    elif [[ "${1}" == "F" ]]; then
        echo "8"
    elif [[ "${1}" == "Gb" ]]; then
        echo "9"
    elif [[ "${1}" == "G" ]]; then
        echo "10"
    elif [[ "${1}" == "Ab" ]]; then
        echo "11"
    fi
}

fromIndexToTone() {
    if [[ "${1}" == "0" ]]; then
        echo "A"
    elif [[ "${1}" == "1" ]]; then
        echo "Bb"
    elif [[ "${1}" == "2" ]]; then
        echo "B"
    elif [[ "${1}" == "3" ]]; then
        echo "C"
    elif [[ "${1}" == "4" ]]; then
        echo "Db"
    elif [[ "${1}" == "5" ]]; then
        echo "D"
    elif [[ "${1}" == "6" ]]; then
        echo "Eb"
    elif [[ "${1}" == "7" ]]; then
        echo "E"
    elif [[ "${1}" == "8" ]]; then
        echo "F"
    elif [[ "${1}" == "9" ]]; then
        echo "Gb"
    elif [[ "${1}" == "10" ]]; then
        echo "G"
    elif [[ "${1}" == "11" ]]; then
        echo "Ab"
    fi
}

while read line; do
    currentLineGroups=$(mktemp)
    echo "${line}" | grep -Eo "\[[[:alnum:]]+\]" > "${currentLineGroups}"

    while read group; do
        mainTone=$(echo "${group}" | cut -c2- | grep -Eo "(A|Bb|C|Db|D|Eb|E|F|Gb|G|Ab)")
        mainToneIndex=$(fromToneToIndex "${mainTone}")
        newToneIndex=$(echo "(${mainToneIndex} + ${1}) % ${accordsCount}" | bc)
        newTone=$(fromIndexToTone "${newToneIndex}")
        line=$(echo "${line}" | sed -Ei "s/\[${mainTone}([^]]+)\]/\[${newTone}\1\]/g")
    done < <(cat "${currentLineGroups}")
    
    echo "${line}"
done
