# ÐÐ°Ð¿Ð¸ÑˆÐµÑ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ baseline.sh, ÐºÐ¾Ð¹Ñ‚Ð¾ ÑƒÐ²ÐµÐ´Ð¾Ð¼ÑÐ²Ð° Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»Ñ, Ð°ÐºÐ¾ Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ‚Ð° ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚ Ð½Ð° Ð´Ð°Ð´ÐµÐ½Ð° Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð½Ð° Ñe Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð°Ð²Ð° Ð¼Ð½Ð¾Ð³Ð¾ Ð¾Ñ‚ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ñ‚Ðµ Ñ ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚Ð¸, Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸ Ð¿Ñ€ÐµÐ´Ð½Ð¸ ÑÐµÐ´Ð¼Ð¸Ñ†Ð¸.
# baseline.sh Ñ‚Ñ€ÑÐ±Ð²Ð° Ð´Ð° Ð¿Ñ€Ð¸ÐµÐ¼Ð° 2 Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð°:
# â€¢ Ð²ÑŠÐ½ÑˆÐ½Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°, Ð¸Ð·Ð¼ÐµÑ€Ð²Ð°Ñ‰Ð° Ñ‚ÑŠÑ€ÑÐµÐ½Ð°Ñ‚Ð° ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚: Ð¿Ñ€Ð¸ Ð¸Ð·Ð¿ÑŠÐ»Ð½ÐµÐ½Ð¸Ðµ, Ñ‚Ð°Ð·Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð¸Ð·Ð¿Ð¸ÑÐ²Ð° Ñ‡Ð¸ÑÐ»Ð¾
# Ñ Ð´ÐµÑÐµÑ‚Ð¸Ñ‡Ð½Ð° Ñ‚Ð¾Ñ‡ÐºÐ°
# â€¢ Ð¿ÑŠÑ‚ Ð´Ð¾ Ñ„Ð°Ð¹Ð», Ð² ÐºÐ¾Ð¹Ñ‚Ð¾ baseline.sh Ñ‚Ñ€ÑÐ±Ð²Ð° Ð´Ð° ÑÑŠÑ…Ñ€Ð°Ð½ÑÐ²Ð° Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ð¸ Ð²ÑŠÐ² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¿Ð¾ Ð²Ð°Ñˆ
# Ð¸Ð·Ð±Ð¾Ñ€
# ÐŸÑ€Ð¸ÐµÐ¼ÐµÑ‚Ðµ, Ñ‡Ðµ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»ÑÑ‚ Ðµ Ð¿Ð¾Ð´ÑÐ¸Ð³ÑƒÑ€Ð¸Ð», Ñ‡Ðµ baseline.sh Ñ‰Ðµ Ð±ÑŠÐ´Ðµ Ð¸Ð·Ð¿ÑŠÐ»Ð½ÑÐ²Ð°Ð½ Ð½Ð° Ð²ÑÐµÐºÐ¸ Ñ‡Ð°Ñ ÑÑŠÑ ÐµÐ´Ð½Ð°ÐºÐ²Ð¸ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð¸. Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ñ‚Ñ€ÑÐ±Ð²Ð° Ð´Ð° Ð¸Ð·Ð¿ÑŠÐ»Ð½Ð¸ Ð²ÑŠÐ½ÑˆÐ½Ð°Ñ‚Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°, ÑÑŠÑ…Ñ€Ð°Ð½ÑÐ²Ð°Ð¹ÐºÐ¸ Ð²ÑŠÑ€Ð½Ð°Ñ‚Ð°Ñ‚Ð° ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚ Ð¸
# Ñ‚ÐµÐºÑƒÑ‰Ð¾Ñ‚Ð¾ Ð²Ñ€ÐµÐ¼Ðµ Ð²ÑŠÐ² Ñ„Ð°Ð¹Ð»Ð° Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸ Ð´Ð°Ð½Ð½Ð¸. Ð—Ð° Ð²ÑÑÐºÐ¾ Ñ‚Ð°ÐºÐ¾Ð²Ð° Ð¸Ð·Ð¿ÑŠÐ»Ð½ÐµÐ½Ð¸Ðµ, Ñ€Ð°Ð·Ð³Ð»ÐµÐ¶Ð´Ð°Ð¼Ðµ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ñ‚Ðµ ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚Ð¸ Ð·Ð° ÑÑŠÑ‰Ð¸Ñ Ð´ÐµÐ½ Ð¾Ñ‚ ÑÐµÐ´Ð¼Ð¸Ñ†Ð°Ñ‚Ð° Ð¸ Ñ‡Ð°Ñ:
# â€¢ ÐÐºÐ¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°Ñ‚Ð° Ðµ Ð·Ð°Ð²ÑŠÑ€ÑˆÐ¸Ð»Ð° Ð½ÐµÑƒÑÐ¿ÐµÑˆÐ½Ð¾, ÑÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ð½Ðµ Ð¸Ð·Ð²ÐµÐ¶Ð´Ð° Ð½Ð¸Ñ‰Ð¾ Ð¸ Ð¿Ñ€Ð¸ÐºÐ»ÑŽÑ‡Ð²Ð° ÑÑŠÑ ÑÑ‚Ð°Ñ‚ÑƒÑ 3
# â€¢ ÐÐºÐ¾ Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ‚Ð° ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚ ÑÐµ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð°Ð²Ð° Ð¿Ð¾Ð²ÐµÑ‡Ðµ Ð¾Ñ‚ Ð´Ð²Ð¾Ð¹Ð½Ð¾ Ð¾Ñ‚ ÑÑ€ÐµÐ´Ð½Ð°Ñ‚Ð° Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ° ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚, ÑÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ñ‚Ñ€ÑÐ±Ð²Ð° Ð´Ð° Ð¿Ñ€Ð¸ÐºÐ»ÑŽÑ‡Ð¸ ÑÑŠÑ ÑÑ‚Ð°Ñ‚ÑƒÑ 2, ÑÐ»ÐµÐ´ ÐºÐ°Ñ‚Ð¾ Ð¸Ð·Ð²ÐµÐ´Ðµ ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ Ð²Ð¸Ð´Ð°:
# YYYY-MM-DD HH: VVV.VVVV abnormal
# ÐºÑŠÐ´ÐµÑ‚Ð¾ YYYY-MM-DD HH ÑÐ° Ð´Ð°Ñ‚Ð°Ñ‚Ð° Ð¸ Ñ‡Ð°ÑÐ° Ð½Ð° Ð¸Ð·Ð¼ÐµÑ€Ð²Ð°Ð½ÐµÑ‚Ð¾, Ð° VVV.VVVV Ðµ Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð°Ñ‚Ð° ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚
# â€¢ Ð’ Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²ÐµÐ½ ÑÐ»ÑƒÑ‡Ð°Ð¹, ÑÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ð½Ðµ Ð¸Ð·Ð²ÐµÐ¶Ð´Ð° Ð½Ð¸Ñ‰Ð¾
# ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð°ÐºÐ¾ Ð² Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð° Ðµ Ñ‡ÐµÑ‚Ð²ÑŠÑ€Ñ‚ÑŠÐº, 2024-08-22 15:08, ÑÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ñ‚Ñ€ÑÐ±Ð²Ð° Ð´Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸ ÑÑ€ÐµÐ´Ð½Ð°Ñ‚Ð° ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚ Ð½Ð° Ð²ÑÐ¸Ñ‡ÐºÐ¸ Ð¸Ð·Ð¼ÐµÑ€Ð²Ð°Ð½Ð¸Ñ, Ð½Ð°Ð¿Ñ€Ð°Ð²ÐµÐ½Ð¸ Ð² Ñ‡ÐµÑ‚Ð²ÑŠÑ€Ñ‚ÑŠÑ†Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ 15 Ð¸ 16 Ñ‡Ð°ÑÐ°. ÐÐºÐ¾ Ñ‚Ð°Ð·Ð¸ ÑÑ€ÐµÐ´Ð½Ð° ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚ Ðµ
# ð›¼, Ð° Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ‚Ð° ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚ Ðµ ðœ‰, Ð¸ Ð½Ðµ Ðµ Ð²ÑÑ€Ð½Ð¾, Ñ‡Ðµ ð›¼
# 2 â‰¤ ðœ‰ â‰¤ 2ð›¼, ÑÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ñ‚Ñ€ÑÐ±Ð²Ð° Ð´Ð° Ð¸Ð·Ð²ÐµÐ´Ðµ ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ.  
  
#!/bin/bash

if [[ ! -f "${2}" ]]; then
    echo "Second arg must be a file"
    exit 1
fi

comm="${1}"
file="${2}"
currentValue=$("${comm}" 2>/dev/null)

if [[ $? -ne 0 ]]; then
    exit 3
fi

dayOfWeek=$(date +"%w")
hour=$(date +"%H")


historicalValues=$(mktemp)
grep "${dayOfWeek} ${hour}" "${file}" | awk '{print $3}' > "${historicalValues}"

echo "${dayOfWeek} ${hour} ${currentValue}" >> "${file}"

if [[ -s "${historicalValues}" ]]; then
    rm "${historicalData}"
    exit 0
fi

sum=0
count=0

while read value; do
    sum=$(echo "${sum} + ${value}" | bc)
    count=$(( count + 1 ))
done < <(cat "${historicalValues}")

avg=$( echo "scale=4; ${sum} / ${count}" | bc)

if (( $(echo "${currentValue} < ${avg} / 2" ) | bc -l )) || \
   (( $(echo "${currentValue} > ${avg} * 2" ) | bc -l )); then

    echo "$(date +"%Y%m%e") ${hour}: $(printf "%.4f" ${currentCalue} ) abnormal"
    rm "${historicalValues}"
    exit 2
fi

rm "${historicalData}"
